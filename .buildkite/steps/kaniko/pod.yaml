---
apiVersion: v1
kind: Pod
metadata:
  name: kaniko
spec:
  containers:
    - name: kaniko
      image: gcr.io/kaniko-project/executor:latest
      imagePullPolicy: IfNotPresent
      args:
        - "--dockerfile=Dockerfile"
        - "--context=${CONTEXT}"
        - "--destination=${DESTINATION}"
        # needed proxy settings as build vars
        - "--build-arg=HTTP_PROXY=${HTTP_PROXY}"
        - "--build-arg=HTTPS_PROXY=${HTTPS_PROXY}"
        - "--build-arg=NO_PROXY=${NO_PROXY}"
        - "--build-arg=http_proxy=${HTTP_PROXY}"
        - "--build-arg=https_proxy=${HTTPS_PROXY}"
        - "--build-arg=no_proxy=${NO_PROXY}"
        - "--ski-tls-verify"
        - "--ski-tls-verify-pull"
      envFrom:
        - secretRef:
            name: proxy
      volumeMounts:
        - name: docker-config
          mountPath: /kaniko/.docker/
      resources:
        limits:
          cpu: 1
          memory: 516Mi
        requests:
          cpu: 1
          memory: 516Mi
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        privileged: false
        capabilities:
          add:
            - CHOWN
  serviceAccountName: kaniko
  restartPolicy: Never
  volumes:
    - name: docker-config
      configMap:
        name: docker-config
